;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; QuayeWorks Hawk-H7 Flight Controller Settings (settings.ini)
; ----------------------------------------------------------------------------
; This INI file stores all user‐tunable parameters, calibration data, and
; configuration flags for the flight controller. After firmware startup,
; any changed value will be saved back here so that future boots use the same
; settings. 
; 
; Sections:
;   [IMU]           → Accelerometer & Gyro calibration offsets
;   [COMPASS]       → Magnetometer calibration & enabling
;   [BARO]          → Barometer (BMP388) configuration
;   [SONAR]         → Rangefinder/sonar configuration
;   [GPS]           → GPS-related settings & thresholds
;   [RC]            → RC input mapping, RSSI thresholds, stick‐arming
;   [BATTERY]       → Battery measurement & failsafe thresholds
;   [ESTIMATOR]     → EKF/UKF thresholds and toggles
;   [ARMING]        → Pre‐arm check enabling/disabling & arming angles
;   [MOTORS]        → Motor output mapping, idle, orientation flags
;   [FAILSAFE]      → Failsafe actions & timing
;   [GEOfENCE]      → Geofence parameters
;   [ATTITUDE]      → Attitude limits (tilt, rates) and PID gains
;   [TELEMETRY]     → Telemetry configuration (link type, baud, messages)
;   [MISC]          → Miscellaneous flags (LED, buzzer, debug)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


[IMU]
; ─── Accelerometer & Gyro Biases (computed during Power‐On Calibration) ───
accel_bias_x       = 0.012      ; Accelerometer X bias (g)
accel_bias_y       = -0.034     ; Accelerometer Y bias (g)
accel_bias_z       = 0.985      ; Accelerometer Z bias (g) (should be ≈1g)
gyro_bias_x        = -0.002     ; Gyro X bias (°/s)
gyro_bias_y        = 0.005      ; Gyro Y bias (°/s)
gyro_bias_z        = 0.001      ; Gyro Z bias (°/s)

; If “calibrate_on_boot = 1”, the FC will re‐compute these biases at each
; power‐on using N samples from MPU6050. Otherwise it will use stored values.
calibrate_on_boot  = 1          ; 0 = use stored biases, 1 = recalibrate each boot
calib_samples      = 200        ; Number of IMU samples to average when calibrating
accel_tol_g        = 0.5        ; Allowed ±g tolerance on each axis for Accelerometer
                                ; (if exceeded during boot, IMU_UNHEALTHY bit is set)

[COMPASS]
; ─── Magnetometer Calibration & Checks ───
compass_enabled        = 1      ; 0 = disabled, 1 = enabled
mag_soft_iron_x        = 0.12   ; Soft-iron offset (X)
mag_soft_iron_y        = -0.07  ; Soft-iron offset (Y)
mag_soft_iron_z        = 0.03   ; Soft-iron offset (Z)
mag_hard_iron_x        = 0.01   ; Hard-iron offset (X)
mag_hard_iron_y        = -0.02  ; Hard-iron offset (Y)
mag_hard_iron_z        = 0.00   ; Hard-iron offset (Z)

; Threshold (Mahalanobis distance) beyond which magnetometer is considered an outlier
mag_maha_threshold     = 4.0    

; If multiple compasses (e.g. external + onboard), specify which is primary
compass_primary        = 0      ; 0 = onboard, 1 = external

; If “compass_auto_save = 1”, any updated offsets from calibration tool
; will be saved here automatically.
compass_auto_save      = 1      

[BARO]
; ─── BMP388 Barometer Settings ───
baro_enabled           = 1      ; 0 = disabled, 1 = enabled
baro_pressure_offset   = 1013.25 ; Sea‐level pressure reference (hPa)
baro_tol_hpa           = 10.0   ; Allowed ±10 hPa deviation at ground level

; “baro_alt_offset” can store a ground‐level altitude reference if needed
baro_alt_offset        = 0.0    ; (m) Altitude at which baro was last zeroed

[SONAR]
; ─── Rangefinder/Sonar Settings ───
sonar_enabled          = 1      ; 0 = disabled, 1 = enabled
sonar_max_distance     = 6.0    ; Maximum valid distance (m)
sonar_min_distance     = 0.2    ; Minimum valid distance (m)
sonar_update_rate_hz   = 10     ; Polling rate for sonar in Hz

; If “sonar_ground_z_offset” is set after calibration (landing), 
; can store average ground distance
sonar_ground_z_offset  = 0.0    ; (m) typical ground clearance reading

[GPS]
; ─── GPS Configuration & Health Check ───
gps_enabled            = 1      ; 0 = disabled, 1 = enabled
gps_baud               = 57600  ; Baud rate for UART to GPS module
gps_min_satellites     = 6      ; Minimum satellites required for a valid fix
gps_max_hdop           = 2.0    ; Maximum allowed HDOP for a valid fix
gps_required_time_sec   = 5     ; Seconds of continuous valid fix before allowing it
gps_hold_after_loss_sec = 3     ; Grace period to reacquire GPS fix in flight

; Coordinates of “home” can be stored after first fix if desired
home_latitude          = 0.0    ; Degrees (set to 0 until first fix)
home_longitude         = 0.0    ; Degrees (set to 0 until first fix)
home_altitude          = 0.0    ; Meters (set to first baro alt when fix acquired)

[RC]
; ─── RC Input & Arming Settings ───
rc_invert_pwm          = 0      ; 0 = normal, 1 = invert PWM polarity (SBUS vs PWM)
rc_rssi_min            = 0      ; 0 disables RSSI gating when no RSSI source is wired
rc_throttle_channel    = 2      ; Channel index (0‐based) for throttle
rc_roll_channel        = 0      ; Channel index for roll
rc_pitch_channel       = 1      ; Channel index for pitch
rc_yaw_channel         = 3      ; Channel index for yaw
rc_arm_stick_threshold = 1800   ; Yaw stick > this (out of 2000) to arm
rc_disarm_stick_thresh = 200     ; Yaw stick < this to disarm
rc_center_threshold    = 50     ; Acceptable deviation from 1000/1500/2000 to count as “centered”

; If “prearm_switch_channel” is set, that channel must be high before arm sticks apply.
prearm_switch_enabled  = 0      ; 0 = disabled, 1 = enabled
prearm_switch_channel  = 4      ; Channel index for pre‐arm switch
prearm_switch_high     = 1800   ; PWM > this to count as “pre‐arm ON”

[BATTERY ]
; ─── Battery & Power Management ───
battery_monitor_enabled = 1     ; 0 = disabled, 1 = enabled
battery_volt_divider     = 11.0 ; Voltage divider ratio (e.g., for 4S, 11:1)
battery_cell_count       = 4    ; Number of cells in pack
battery_warning_volts    = 3.5  ; Per‐cell voltage for warning (under load)
battery_critical_volts   = 3.3  ; Per‐cell voltage for critical (immediate action)
battery_auto_rtl_enabled = 1    ; If 1, auto‐RTL when warning threshold is reached
battery_log_mAh          = 2500 ; Total pack capacity (mAh) for capacity tracking
battery_low_mAh          = 200   ; Remaining mAh before “low battery” warning
battery_crit_mAh         = 100   ; Remaining mAh before “critical battery” action

; Current sensing (INA219)
ina219_i2c_address       = 0x40 ; Default INA219 I²C address
ina219_shunt_ohm         = 0.1  ; Shunt resistor value in ohms
ina219_max_expected_amps  = 30   ; Max current expected (for calibration)

[ESTIMATOR]
; ─── EKF/UKF & Sensor Fusion Settings ───
ekf_enabled                = 1    ; 0 = disabled (use raw attitude only)
ekf_innovation_gps         = 5.0  ; GPS position innovation gate (Mahalanobis)
ekf_innovation_mag         = 4.0  ; Magnetometer innovation gate
ekf_innovation_baro        = 3.0  ; Barometer innovation gate
ekf_gyro_noise_sigma       = 0.000174 ; Gyro noise (rad/s/√Hz) (example)
ekf_accel_noise_sigma      = 0.01     ; Accel noise (m/s²/√Hz)
ekf_min_obs_time_sec       = 2.0      ; Min time (s) to consider EKF “converged”
ekf_pos_var_limit          = 2.0      ; Max allowed position variance (m²) before failsafe
ekf_vel_var_limit          = 1.5      ; Max allowed velocity variance (m²/s²)

[ARMING]
; ─── Pre‐Arm Check Toggles & Limits ───
;   Each bit in “arming_checks_mask” corresponds to a specific check:
;   Bit 0 = IMU healthy
;   Bit 1 = Compass healthy
;   Bit 2 = Baro healthy
;   Bit 3 = Sonar healthy
;   Bit 4 = GPS healthy
;   Bit 5 = RC healthy
;   Bit 6 = Battery healthy
;   Bit 7 = EKF healthy
;   Bit 8 = CPU timing OK
;   others = reserved
;   To disable a specific check, clear its bit (0=disable, 1=enable).
arming_checks_mask        = 0x00FF ; Enable bits 0–7 (all mandatory checks)

arm_tilt_limit_deg        = 25     ; Max tilt (deg) allowed while arming (craft must be level)
arm_wait_time_ms          = 1000   ; Time (ms) sticks must be held in arm position

; If “arm_beeper = 1”, play arming confirmation tone
arm_beeper                = 1

[MOTORS]
; ─── Motor Output & Orientation Settings ───
motor_count               = 4      ; Total # of motors (4, 6, 8, etc.)
motor1_pin                = 1      ; Timer channel or PWM index for M1
motor2_pin                = 2
motor3_pin                = 3
motor4_pin                = 4
motor5_pin                = 0      ; 0 if not used
motor6_pin                = 0

; Throttle endpoints (us for PWM; for DShot use integer values 48–2047)
motor_pwm_min_us          = 1000   ; ESC idle throttle pulse width
motor_pwm_max_us          = 2000   ; ESC full throttle pulse width
motor_idle_percent        = 5      ; % throttle at idle (for spin‐on‐arm)

; Motor rotation direction flags (0 = CW, 1 = CCW). Enforce alternation.
motor1_dir                = 0      ; 0=CW, 1=CCW
motor2_dir                = 1
motor3_dir                = 0
motor4_dir                = 1
motor5_dir                = 0      ; Unused if motor_count < 5
motor6_dir                = 1

; If “motor_auto_detect = 1”, try to detect orientation via IMU feedback:
motor_auto_detect         = 0

; Save motor orientation back to settings.ini if changed (auto‐save)
motor_orientation_auto_save = 1

[FAILSAFE]
; ─── Failsafe Actions & Timing ───
fs_battery_action         = 2      ; 0=Disabled, 1=Warn only, 2=RTL, 3=Land
fs_gps_loss_action        = 1      ; 0=Disabled, 1=AltHold, 2=RTL, 3=Land
fs_rc_loss_action         = 2      ; 0=Disabled, 1=AltHold, 2=RTL, 3=Land
fs_ekf_loss_action        = 3      ; 0=Disabled, 1=Hold, 2=AltHold, 3=Land
fs_geofence_action        = 2      ; 0=Disabled, 1=Hold, 2=RTL, 3=Land
fs_batt_warn_delay_sec    = 2      ; Delay (s) after battery < warning before action
fs_rc_loss_delay_sec      = 0.5    ; Delay (s) after RC lost before action
fs_gps_loss_delay_sec     = 1.0    ; Delay (s) after GPS fix invalid before action

[GEOfENCE]
; ─── Geofence (Home Boundary) Settings ───
geofence_enabled          = 1      ; 0 = disabled, 1 = enabled
geofence_center_lat       = 0.0    ; Set after first GPS fix
geofence_center_lon       = 0.0
geofence_center_alt       = 0.0    ; (m) Altitude center (takeoff point)
geofence_radius_m         = 500    ; Horizontal radius in meters
geofence_alt_max_m        = 120    ; Max altitude above home in meters

; Secondary boundary (beyond which we force Land immediately)
geofence_max_distance_m   = 600    ; m (100 m beyond primary fence)

[ATTITUDE]
; ─── Attitude Limits & PID Gains ───
max_tilt_deg              = 60     ; Max allowed tilt during flight
max_roll_rate_dps         = 200    ; Max roll rate (°/s)
max_pitch_rate_dps        = 200    ; Max pitch rate (°/s)
max_yaw_rate_dps          = 200    ; Max yaw rate (°/s)

; PID Gains for Attitude Controller (example defaults)
pid_roll_p                = 4.50
pid_roll_i                = 0.020
pid_roll_d                = 25.0

pid_pitch_p               = 4.50
pid_pitch_i               = 0.020
pid_pitch_d               = 25.0

pid_yaw_p                 = 4.00
pid_yaw_i                 = 0.020
pid_yaw_d                 = 0.0

; Feedforward and filtering parameters (if any)
yaw_ff                    = 0.0
filter_gyro_cutoff_hz     = 90     ; Low-pass filter on gyro data (Hz)

[TELEMETRY]
; ─── Telemetry Link & Messages ───
telemetry_enabled         = 1      ; 0 = disabled, 1 = enabled
telemetry_protocol        = 2      ; 1=Custom, 2=MAVLink, 3=MSP
telemetry_baud            = 57600  ; Baud rate for telemetry port
telemetry_stream_rate_hz  = 10     ; How often to send status messages
telemetry_send_attitude   = 1      ; 0 = no, 1 = yes
telemetry_send_status     = 1      ; Health & failsafe status every second
telemetry_send_sensors    = 0      ; IMU raw data (for debugging, 0=off,1=on)
telemetry_sysid           = 1      ; MAVLink system ID (if using MAVLink)

[MISC]
; ─── Miscellaneous Flags & Debug ───
led_enabled               = 1      ; 0 = disable LED status, 1 = enable
led_mode                  = 2      ; 0=Off, 1=Solid, 2=Blink on status change
buzzer_enabled            = 1      ; 0 = disable buzzer entirely
debug_log_enabled         = 0      ; 0 = no logs, 1 = log to SD (cycle logs)
log_level                 = 2      ; 0=Error,1=Warn,2=Info,3=Debug

; If “factory_reset = 1”, the next reboot will wipe ini and restore defaults.
factory_reset             = 0      
